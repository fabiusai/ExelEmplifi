<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Report Social</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ffc72c;
            --secondary-color: #003366;
            --background-color: #f4f7f9;
            --text-color: #333333;
            --light-grey: #e9ecef;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --error-color: #dc3545;
            --font-family: 'Open Sans', sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; font-size: 16px; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--secondary-color); color: white; padding: 20px 30px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--box-shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        header h1 { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
        header p { font-size: 1rem; opacity: 0.9; }
        main { display: flex; flex-direction: column; gap: 30px; }
        
        /* Stili per le card (da app2) */
        .section-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 25px 30px; }
        .section-card h2 { font-size: 1.5rem; margin-bottom: 20px; color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        
        /* Stili per la Fase 1 (da app1) */
        .controls { display:flex; align-items:center; gap:1rem; margin-top:1rem; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        select, input[type="file"] { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 0.95rem; }
        #analyze-data { 
            cursor:pointer; 
            background: #FFD700; /* Giallo da app1 */ 
            color: #333; /* Testo scuro per leggibilità */ 
            border:none; 
            padding:0.6rem 1.2rem; 
            font-weight:bold; 
            border-radius:4px; 
            box-shadow:0 1px 3px rgba(0,0,0,0.1); 
            transition: background-color 0.2s; 
            align-self: flex-end; 
            font-size: 0.95rem;
        }
        #analyze-data:hover { background-color: #e6c300; }
        #analyze-data:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Stili per Conflitti ed Editor (da app2) */
        #conflict-container { border-left: 5px solid var(--error-color); }
        .conflict-item { background-color: #fff8f8; padding: 15px; margin-bottom: 10px; border: 1px solid var(--error-color); border-radius: 4px; }
        .conflict-item p { margin-bottom: 10px; }
        .conflict-item .resolve-buttons button { margin-right: 10px; background-color: var(--secondary-color); color: white; }
        #editor-container { display: flex; flex-direction: column; gap: 20px; }
        .label-group { background: #fdfdfd; border: 1px solid var(--border-color); border-radius: var(--border-radius); min-height: 100px; }
        .label-header { background-color: var(--light-grey); color: var(--secondary-color); padding: 12px 20px; font-weight: 700; font-size: 1.2rem; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); border-bottom: 1px solid var(--border-color); }
        .argument-list { padding: 10px; list-style-type: none; }
        .argument-item { display: flex; align-items: center; padding: 12px 10px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; gap: 15px; transition: box-shadow 0.2s; flex-wrap: nowrap; }
        .argument-item:hover { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .drag-handle { cursor: move; color: #adb5bd; }
        .argument-text { flex-grow: 1; border: none; border-bottom: 1px solid transparent; padding: 5px; font-size: 1rem; font-family: inherit; transition: border-color 0.3s; min-width: 200px;}
        .argument-text:focus { outline: none; border-bottom: 1px solid var(--secondary-color); }
        .institutional-check { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .institutional-check input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--secondary-color); cursor: pointer; }
        .argument-link a { color: var(--secondary-color); text-decoration: none; font-size: 1.2rem; transition: color 0.2s; }
        .argument-link a:hover { color: var(--primary-color); }
        .sortable-ghost { opacity: 0.4; background-color: #cce5ff; border: 1px dashed var(--secondary-color); }
        
        /* Stili per bottoni (da app2) */
        .button { background-color: var(--primary-color); color: var(--secondary-color); border: 2px solid var(--secondary-color); padding: 12px 25px; font-size: 1rem; font-weight: 700; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .button:hover:not(:disabled) { background-color: var(--secondary-color); color: var(--primary-color); }
        .button:disabled { background-color: #adb5bd; border-color: #6c757d; color: white; cursor: not-allowed; }
        #export-button-container { text-align: right; margin-top: 20px; }
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            header { flex-direction: column; text-align: center; }
            #export-button-container { text-align: center; }
            .argument-item { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div>
                <h1>Editor Report Social</h1>
                <p>Carica, elabora e organizza i tuoi contenuti in modo efficiente.</p>
            </div>
        </header>

        <main>
            <section class="section-card">
              <h2>1. Carica file e scegli il mese</h2>
              <p>Seleziona il file Excel da Emplifi e specifica il mese di riferimento per il report.</p>
              <div class="controls">
                <div class="input-group">
                  <label for="file-input-emplifi">Carica file Excel:</label>
                  <input type="file" id="file-input-emplifi" accept=".xlsx,.xls" />
                </div>
                <div class="input-group">
                  <label for="month-select">Mese del report:</label>
                  <select id="month-select">
                    <option value="01">Gennaio</option>
                    <option value="02">Febbraio</option>
                    <option value="03">Marzo</option>
                    <option value="04">Aprile</option>
                    <option value="05">Maggio</option>
                    <option value="06">Giugno</option>
                    <option value="07">Luglio</option>
                    <option value="08">Agosto</option>
                    <option value="09">Settembre</option>
                    <option value="10">Ottobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Dicembre</option>
                  </select>
                </div>
                <div class="input-group">
                    <label for="year-select">Anno del report:</label>
                    <select id="year-select"></select>
                </div>
                <button id="analyze-data" style="align-self: flex-end;">Analizza dati</button>
              </div>
            </section>
            
            <section id="conflict-container" class="section-card hidden">
                <h2>2. Conflitti Rilevati</h2>
                <p>Sono stati trovati argomenti duplicati in diverse "Label". Per favore, risolvi i conflitti per continuare.</p>
                <div id="conflict-list"></div>
            </section>

            <section id="editor-section" class="section-card hidden">
                <h2>3. Organizza e Modifica Argomenti</h2>
                <div id="editor-container"></div>
                <div id="export-button-container">
                    <button id="export-button" class="button" disabled>
                        <i class="fa-solid fa-file-excel"></i> Esporta Excel Aggiornato
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- Variabili globali da entrambe le app ---
        let workbookEmplifi = null;
        let processedData = []; // Dati elaborati da App1
        let originalData = [];  // Dati passati ad App2
        let groupedData = {};   // Dati raggruppati per App2

        // --- Elementi DOM da App 1 ---
        const analyzeBtn = document.getElementById('analyze-data');
        const fileInputEmplifi = document.getElementById('file-input-emplifi');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');

        // --- Elementi DOM da App 2 ---
        const conflictContainer = document.getElementById('conflict-container');
        const conflictList = document.getElementById('conflict-list');
        const editorSection = document.getElementById('editor-section');
        const editorContainer = document.getElementById('editor-container');
        const exportButton = document.getElementById('export-button');

        // --- Funzioni da App 1 (Fase 1) ---
        function populateYearSelector() {
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear;
        }
        
        populateYearSelector(); // Chiamata diretta
        const currentMonth = new Date().getMonth() + 1;
        monthSelect.value = String(currentMonth).padStart(2, '0');

        fileInputEmplifi.addEventListener('change', e => {
          const f = e.target.files[0];
          if (!f) { workbookEmplifi = null; return; }
          const reader = new FileReader();
          reader.onload = ev => { workbookEmplifi = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' }); };
          reader.readAsArrayBuffer(f);
          
          // Resetta UI di App2
          resetUI();
          processedData = [];
          originalData = [];
        });

        // Listener "Analizza Dati" (Il "Ponte" tra App1 e App2)
        analyzeBtn.addEventListener('click', () => {
          if (!workbookEmplifi) return alert('Seleziona prima un file Emplifi.');
          
          // Resetta l'interfaccia in caso di ri-analisi
          resetUI();
          
          const ws = workbookEmplifi.Sheets[workbookEmplifi.SheetNames[0]];
          let data = XLSX.utils.sheet_to_json(ws, { raw: true, defval: '' });

          if (!data.length) return alert('File vuoto o illeggibile.');

          // Rileva se il file è un RAW Emplifi o un file GIÀ ELABORATO (controllando intestazioni tipiche)
          const isProcessedFile = data[0] && ('Argomento' in data[0] || 'Canale' in data[0]);

          if (isProcessedFile) {
            // --- LOGICA IMPORTAZIONE FILE GIÀ ELABORATO ---
            processedData = data.map(r => {
                let formattedDate = r['Data'] || '';
                // Gestione data nel caso Excel la legga come numero seriale
                if (typeof r['Data'] === 'number') {
                    const parsedDate = XLSX.SSF.parse_date_code(r['Data']);
                    const jsDate = new Date(parsedDate.y, parsedDate.m - 1, parsedDate.d);
                    formattedDate = [String(jsDate.getDate()).padStart(2, '0'), String(jsDate.getMonth() + 1).padStart(2, '0'), jsDate.getFullYear().toString()].join('/');
                }

                return {
                    Link: r['Link'] || '', 'Dettagli Emplifi': r['Dettagli Emplifi'] || '',
                    Mese: r['Mese'] || '', Data: formattedDate,
                    Canale: r['Canale'] || '',
                    Interazioni: r['Interazioni'] || '', Visualizzazioni: r['Visualizzazioni'] || '',
                    'Persone raggiunte': r['Persone raggiunte'] || '', Click: r['Click'] || '',
                    'Like e reazioni': r['Like e reazioni'] || '', Condivisioni: r['Condivisioni'] || '',
                    Commenti: r['Commenti'] || '', Campagna: r['Campagna'] || '',
                    Label: r['Label'] || '', Argomento: r['Argomento'] || '', Copy: r['Copy'] || '',
                    Istituzionale: r['Istituzionale'] || '',
                    OriginalLabels: '' // Non disponibile/necessario nel ri-edit
                };
            });

          } else {
            // --- LOGICA ORIGINALE (FILE RAW EMPLIFI) ---
            data = data.filter(r => !(r['Video view count'] === '' && r['Total impressions'] === ''));
            if (!data.length) return alert('Nessun dato valido trovato dopo il filtraggio.');

            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;
            const meseDelReport = `01/${selectedMonth}/${selectedYear}`;

            processedData = data.map(r => {
                const dateCell = r['Date'];
                let formattedDate = '';
                if (dateCell instanceof Date) {
                formattedDate = [String(dateCell.getDate()).padStart(2, '0'), String(dateCell.getMonth() + 1).padStart(2, '0'), dateCell.getFullYear().toString()].join('/');
                } else if (typeof dateCell === 'number' && dateCell > 1) {
                const parsedDate = XLSX.SSF.parse_date_code(dateCell);
                const jsDate = new Date(parsedDate.y, parsedDate.m - 1, parsedDate.d, parsedDate.H || 0, parsedDate.M || 0, parsedDate.S || 0);
                formattedDate = [String(jsDate.getDate()).padStart(2, '0'), String(jsDate.getMonth() + 1).padStart(2, '0'), jsDate.getFullYear().toString()].join('/');
                } else if (typeof dateCell === 'string' && dateCell.length > 0) {
                formattedDate = dateCell;
                }
                
                const allLabels = (r['Labels'] || '').split(';').map(s => s.trim());
                const hasIstLabel = allLabels.includes('#IST');
                const labelsForProcessing = allLabels.filter(l => l !== '#IST');
                const labelValue = labelsForProcessing.filter(l => l.startsWith('#')).map(l => ({'#PES':'Prodotti e servizi', '#TER':'Territorio', '#ISR':'Investor e stakeholder relations', '#FIL':'Filatelia', '#EB':'Employer branding', '#P160':'Poste 160', '#NED':'News editoriali', '#CET':'CSR e trasparenza', '#DEI':'Digital e Innovazione', '#ST':'Storici', '#RIC':'Ricorrenze'}[l] || l))[0] || '';
                const argomentoValue = labelsForProcessing.filter(l => !l.startsWith('#'))[0] || '';
                const hasKeywords = /lasco|del fante|rovere/i.test((r['Content'] || '').toLowerCase());
                const isIstituzionalePreliminary = (hasKeywords || hasIstLabel) ? 1 : '';

                const platformRaw = r['Platform'] || '';
                const platform = platformRaw ? platformRaw.charAt(0).toUpperCase() + platformRaw.slice(1).toLowerCase() : '';
                const authorName = (r['Author name'] || '').trim();
                const canaleValue = (authorName && authorName !== 'Poste Italiane') ? `${platform} ${authorName}` : platform;
                
                return {
                Link: r['View on platform'] || r['Content type'] || '', 'Dettagli Emplifi': r['Post detail URL'] || '',
                Mese: meseDelReport, Data: formattedDate,
                Canale: canaleValue,
                Interazioni: r['Total interactions'] || r['Taps forward'] || '', Visualizzazioni: r['Total impressions'] || r['Video view count'] || '',
                'Persone raggiunte': Number(r['Total reach']) > 0 ? r['Total reach'] : '', Click: Number(r['Post clicks']) > 0 ? r['Post clicks'] : '',
                'Like e reazioni': Number(r['Total reactions']) > 0 ? r['Total reactions'] : '', Condivisioni: Number(r['Total shares']) > 0 ? r['Total shares'] : '',
                Commenti: Number(r['Total comments']) > 0 ? r['Total comments'] : '', Campagna: Number(r['Paid impression']) > 0 ? 'Campagna' : 'Editoriale',
                Label: labelValue, Argomento: argomentoValue, Copy: r['Content'] || '', Istituzionale: isIstituzionalePreliminary,
                OriginalLabels: r['Labels'] || ''
                };
            });
          }

          // --- "IL PONTE" ---
          // Passa i dati elaborati da App1 alla logica di App2
          originalData = processedData;
          // Avvia la logica di App2 (controllo conflitti e rendering editor)
          processData(); 
        });

        // --- Funzioni da App 2 (Fase 2 & 3) ---

        function getTrimmedString(value) {
            if (value === null || typeof value === 'undefined') return '';
            return String(value).trim();
        }

        function processData() {
            groupedData = {};
            const argumentToLabelMap = new Map();
            const conflicts = new Map();
            
            if (!originalData || originalData.length === 0) {
                 return alert("Nessun dato elaborato da visualizzare. L'analisi potrebbe aver fallito.");
            }

            originalData.forEach((row) => {
                const argument = getTrimmedString(row['Argomento']);
                const label = getTrimmedString(row['Label']);
                if (!argument || !label) return;
                if (argumentToLabelMap.has(argument) && argumentToLabelMap.get(argument) !== label) {
                    if (!conflicts.has(argument)) {
                        conflicts.set(argument, new Set([argumentToLabelMap.get(argument)]));
                    }
                    conflicts.get(argument).add(label);
                } else {
                    argumentToLabelMap.set(argument, label);
                }
            });
            if (conflicts.size > 0) {
                displayConflicts(conflicts);
                return;
            }
            originalData.forEach(row => {
                const label = getTrimmedString(row['Label']);
                const argument = getTrimmedString(row['Argomento']);
                if (!label || !argument) return;
                const isInstitutional = row['Istituzionale'] == 1;
                const link = row['Link'];
                if (!groupedData[label]) groupedData[label] = {};
                if (!groupedData[label][argument]) {
                    groupedData[label][argument] = { isInstitutional: false, link: null };
                }
                if (isInstitutional) groupedData[label][argument].isInstitutional = true;
                if (!groupedData[label][argument].link && link) groupedData[label][argument].link = link;
            });
            renderEditor();
        }

        function resetUI() {
            conflictContainer.classList.add('hidden');
            conflictList.innerHTML = '';
            editorSection.classList.add('hidden');
            editorContainer.innerHTML = '';
            exportButton.disabled = true;
        }

        function displayConflicts(conflicts) {
            conflictContainer.classList.remove('hidden');
            conflictList.innerHTML = '';
            conflicts.forEach((labels, argument) => {
                const conflictItem = document.createElement('div');
                conflictItem.className = 'conflict-item';
                let labelsText = Array.from(labels).map(l => `"${l}"`).join(' e ');
                conflictItem.innerHTML = `<p>L'argomento <strong>"${escapeHtml(argument)}"</strong> è presente in più Label: ${labelsText}.</p><p>Scegli la Label corretta:</p><div class="resolve-buttons"></div>`;
                const buttonsContainer = conflictItem.querySelector('.resolve-buttons');
                labels.forEach(label => {
                    const button = document.createElement('button');
                    button.className = 'button';
                    button.textContent = `Assegna a "${label}"`;
                    button.onclick = () => resolveConflict(argument, label);
                    buttonsContainer.appendChild(button);
                });
                conflictList.appendChild(conflictItem);
            });
        }
        
        function resolveConflict(argumentToFix, correctLabel) {
            originalData.forEach(row => {
                if (getTrimmedString(row['Argomento']) === argumentToFix) row['Label'] = correctLabel;
            });
            resetUI();
            processData();
        }
        
        function escapeHtml(str) {
            return String(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function renderEditor() {
            editorSection.classList.remove('hidden');
            editorContainer.innerHTML = '';
            const labels = Object.keys(groupedData).sort();
            labels.forEach(label => {
                const labelGroup = document.createElement('div');
                labelGroup.className = 'label-group';
                labelGroup.innerHTML = `<div class="label-header">${escapeHtml(label)}</div>`;
                const argumentList = document.createElement('ul');
                argumentList.className = 'argument-list';
                argumentList.id = `list-${label.replace(/\s+/g, '-')}`;
                const argumentsInLabel = Object.keys(groupedData[label]).sort();
                argumentsInLabel.forEach(argument => {
                    const argData = groupedData[label][argument];
                    const argumentItem = document.createElement('li');
                    argumentItem.className = 'argument-item';
                    argumentItem.dataset.originalArgument = argument;
                    const checkboxId = `check-${label.replace(/[^a-zA-Z0-9]/g, '-')}-${argument.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    argumentItem.innerHTML = `
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <input type="text" class="argument-text" value="${escapeHtml(argument)}">
                        <div class="institutional-check">
                            <input type="checkbox" id="${checkboxId}" ${argData.isInstitutional ? 'checked' : ''}>
                            <label for="${checkboxId}">Istituzionale</label>
                        </div>
                        <div class="argument-link">
                            ${argData.link ? `<a href="${escapeHtml(String(argData.link))}" target="_blank" title="Apri link"><i class="fa-solid fa-link"></i></a>` : ''}
                        </div>`;
                    argumentList.appendChild(argumentItem);
                });
                labelGroup.appendChild(argumentList);
                editorContainer.appendChild(labelGroup);
            });
            document.querySelectorAll('.argument-list').forEach(list => {
                new Sortable(list, { group: 'shared', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost' });
            });
            exportButton.disabled = false;
        }

        function handleExport() {
            const btnOriginalText = exportButton.innerHTML;
            exportButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Elaborazione...';
            exportButton.disabled = true;
            setTimeout(() => {
                try {
                    // Logica da App 2: Legge lo stato dell'interfaccia
                    let updatedData = JSON.parse(JSON.stringify(originalData));
                    const uiStateMap = new Map();
                    document.querySelectorAll('.label-group').forEach(labelGroup => {
                        const newLabel = labelGroup.querySelector('.label-header').textContent;
                        labelGroup.querySelectorAll('.argument-item').forEach(item => {
                            const originalArgument = item.dataset.originalArgument;
                            const newArgumentText = item.querySelector('.argument-text').value;
                            const newIsInstitutional = item.querySelector('.institutional-check input').checked;
                            uiStateMap.set(originalArgument, { newLabel, newArgumentText, newIsInstitutional });
                        });
                    });
                    
                    updatedData.forEach(row => {
                        const originalArgument = getTrimmedString(row['Argomento']);
                        if (uiStateMap.has(originalArgument)) {
                            const updates = uiStateMap.get(originalArgument);
                            row['Label'] = updates.newLabel;
                            row['Argomento'] = updates.newArgumentText;
                            row['Istituzionale'] = updates.newIsInstitutional ? 1 : '';
                        }
                    });
                    
                    // Ordinamento da App 2
                    updatedData.sort((a, b) => {
                        const dateA = convertToDate(a.Data);
                        const dateB = convertToDate(b.Data);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateA - dateB;
                    });
                    
                    // --- LOGICA DI EXPORT INIETTATA DA APP 1 ---
                    
                    // --- MODIFICA: INIZIO NUOVA LOGICA PER WHATSAPP ---
                    const finalOutput = [];
                    if (updatedData.length > 0) {
                        const allHeaders = Object.keys(updatedData[0]);

                        updatedData.forEach(row => {
                            // Aggiunge sempre la riga originale all'output
                            finalOutput.push(row);

                            // Controlla la condizione per creare la riga aggiuntiva di Whatsapp
                            const isYouTube = (row.Canale || '').trim() === 'Youtube';
                            const hasWhaTag = (row.OriginalLabels || '').includes('#WHA');
                            
                            if (isYouTube && hasWhaTag) {
                                // Crea un oggetto vuoto per la nuova riga
                                const newWhatsappRow = {};
                                allHeaders.forEach(header => { newWhatsappRow[header] = ''; });

                                // Popola solo i campi specifici richiesti per la nuova riga
                                newWhatsappRow.Canale = 'Whatsapp';
                                newWhatsappRow.Link = 'Post Whatsapp';
                                newWhatsappRow.Mese = row.Mese;
                                newWhatsappRow.Data = row.Data;
                                newWhatsappRow.Campagna = row.Campagna;
                                newWhatsappRow.Label = row.Label;
                                newWhatsappRow.Argomento = row.Argomento;
                                newWhatsappRow.Copy = row.Copy;
                                newWhatsappRow.Istituzionale = row.Istituzionale;
                                
                                // Aggiunge la nuova riga di Whatsapp all'output
                                finalOutput.push(newWhatsappRow);
                            }
                        });
                    }
                    // --- MODIFICA: FINE LOGICA WHATSAPP ---
                    
                    if (finalOutput.length === 0) {
                        return alert('Nessun dato finale da esportare.');
                    }

                    // Rimuove la colonna di supporto 'OriginalLabels'
                    finalOutput.forEach(row => delete row.OriginalLabels);

                    const newWs = XLSX.utils.json_to_sheet(finalOutput);
                    
                    // Formattazione celle data da App 1
                    const header = Object.keys(finalOutput[0]);
                    const meseColIndex = header.indexOf('Mese');
                    const dataColIndex = header.indexOf('Data');

                    for (let R = 1; R <= finalOutput.length; R++) {
                        if (meseColIndex !== -1) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: meseColIndex });
                        const cell = newWs[cellAddress];
                        if (cell && cell.v) {
                            const [day, month, year] = cell.v.split('/');
                            cell.t = 'd';
                            cell.v = new Date(year, month - 1, day);
                            cell.z = 'dd/mm/yyyy';
                        }
                        }
                        
                        if (dataColIndex !== -1) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: dataColIndex });
                        const cell = newWs[cellAddress];
                        if (cell) {
                            cell.t = 's'; // Forza la colonna 'Data' come testo
                        }
                        }
                    }
                    
                    // Creazione file da App 1
                    const newWb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWb, newWs, "Report Elaborato");
                    
                    // --- MODIFICA PER NOME FILE DINAMICO ---
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const timestamp = `${year}_${month}_${day}_${hours}_${minutes}`;
                    const fileName = `report_elaborato_${timestamp}.xlsx`;
                    
                    XLSX.writeFile(newWb, fileName);
                    // --- FINE MODIFICA ---

                    // --- FINE LOGICA INIETTATA DA APP 1 ---
                    
                    exportButton.innerHTML = '<i class="fa-solid fa-check"></i> Fatto!';
                    setTimeout(() => { exportButton.innerHTML = btnOriginalText; exportButton.disabled = false; }, 2000);
                } catch (err) {
                    console.error("Errore durante l'esportazione:", err);
                    alert("Si è verificato un errore during la creazione del file Excel.");
                    exportButton.innerHTML = btnOriginalText;
                    exportButton.disabled = false;
                }
            }, 50);
        }
        
        function convertToDate(excelDate) {
            if (typeof excelDate === 'number') {
                return new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            }
            if (typeof excelDate === 'string') {
                const parts = excelDate.match(/(\d+)/g);
                if (!parts || parts.length < 3) return new Date(excelDate);
                let year, month, day;
                if (parts[2] && parts[2].length === 4) {
                    day = parseInt(parts[0], 10);
                    month = parseInt(parts[1], 10) - 1;
                    year = parseInt(parts[2], 10);
                } else if (parts[0] && parts[0].length === 4) {
                    year = parseInt(parts[0], 10);
                    month = parseInt(parts[1], 10) - 1;
                    day = parseInt(parts[2], 10);
                } else {
                    return new Date(excelDate);
                }
                return new Date(year, month, day);
            }
            return null;
        }

        function formatDateToDDMMYYYY(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Listener per il pulsante di Esportazione (App 2)
        exportButton.addEventListener('click', handleExport);

    });
    </script>
</body>
</html>
